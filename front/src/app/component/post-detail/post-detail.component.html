<app-header></app-header>

<div class="page">
  <button class="back" routerLink="/posts">
    <mat-icon>arrow_back</mat-icon>
  </button>

  <mat-card *ngIf="post; else loadingOrError" class="post">
    <mat-card-header>
      <mat-card-title>{{ post.title }}</mat-card-title>
      <mat-card-subtitle>
        {{ post.createdAt | date:'dd/MM/yyyy' }} ·
         {{ post.authorPseudo || 'Anonyme' }} ·
         {{ post.title }}
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content class="content">
      <p>{{ post.content }}</p>
      <mat-divider></mat-divider>

      <h3>Commentaires</h3>

      <div class="comments">
        <div *ngFor="let c of comments; trackBy: trackById" class="comment">
          <div class="avatar" [attr.aria-label]="c.auteurUsername">
            {{ (c.auteurUsername || 'U') | slice:0:1 }}
          </div>

          <div class="bubble">
            <div class="who">
              <span class="name">{{ c.auteurUsername || 'Utilisateur' }}</span>
              <span class="date">{{ c.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
            <div class="text">{{ c.contenu }}</div>
          </div>
        </div>

        <div *ngIf="!comments.length" class="empty">Aucun commentaire pour l’instant.</div>
      </div>

      <form [formGroup]="commentForm" (ngSubmit)="sendComment()" class="form">
        <mat-form-field appearance="outline" class="field">
          <mat-label>Écrivez ici votre commentaire</mat-label>
          <textarea matInput rows="3" formControlName="contenu"></textarea>
        </mat-form-field>

        <button mat-fab type="submit" [disabled]="commentForm.invalid || sending" aria-label="Envoyer">
          <mat-icon *ngIf="!sending">send</mat-icon>
          <mat-progress-spinner *ngIf="sending" mode="indeterminate" diameter="24"></mat-progress-spinner>
        </button>
      </form>
    </mat-card-content>
  </mat-card>

  <ng-template #loadingOrError>
    <mat-progress-spinner *ngIf="loading" mode="indeterminate"></mat-progress-spinner>
    <div *ngIf="!loading && errorMsg" class="error">{{ errorMsg }}</div>
  </ng-template>
</div>
