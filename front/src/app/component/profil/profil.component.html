<app-header></app-header>

<div class="profile-container">
  <!-- Section Profil Utilisateur -->
  <mat-card class="profile-section" *ngIf="profile">
    <mat-card-header>
      <mat-card-title>Profil utilisateur</mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <!-- Informations du profil -->
      <div class="profile-form">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Username</mat-label>
          <input matInput [value]="profile.firstname + ' ' + profile.lastname">
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Email</mat-label>
          <input matInput [value]="profile.email" >
        </mat-form-field>
      </div>

      <div class="profile-actions">
        <button mat-raised-button color="primary" (click)="openUpdateDialog()">
          Sauvegarder
        </button>
        <button mat-button color="warn" (click)="logout()">
          Se déconnecter
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Section Souscriptions -->
  <div class="subscriptions-section" *ngIf="profile">
    <h2 class="section-title">Souscriptions</h2>

    <div class="subscriptions-grid">
      <!-- Carte pour chaque souscription -->
      <mat-card *ngFor="let subscription of profile.subscriptions" class="subscription-card">
        <mat-card-header>
          <mat-card-title>{{ subscription.themeName || 'Titre du topic' }}</mat-card-title>
        </mat-card-header>

        <mat-card-content>
          <p class="subscription-description">
            {{ subscription.themeDescription || 'Description: lorem ipsum is simply dummy text of the printing and typesetting industry. Lorem ipsum has been the industry\'s standard...' }}
          </p>
        </mat-card-content>

        <mat-card-actions>
          <button mat-raised-button
                  color="primary"
                  class="unsubscribe-btn"
                  (click)="unsubscribe(subscription)"
                  [disabled]="processingUnsubscribe">
            Se désabonner
          </button>
        </mat-card-actions>
      </mat-card>

      <!-- Message si aucune souscription -->
      <div *ngIf="!profile.subscriptions || profile.subscriptions.length === 0" class="no-subscriptions">
        <mat-icon>info</mat-icon>
        <p>Vous n'êtes abonné à aucun thème pour le moment.</p>
        <button mat-raised-button color="primary" routerLink="/themes">
          Découvrir les thèmes
        </button>
      </div>
    </div>
  </div>

  <!-- Loading spinner -->
  <div *ngIf="loading" class="loading-container">
    <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
  </div>

  <!-- Error message -->
  <div *ngIf="errorMsg" class="error-container">
    <mat-icon>error</mat-icon>
    <p>{{ errorMsg }}</p>
  </div>
</div>

<!-- Dialog de mise à jour du profil -->
<ng-template #updateDialog>
  <h2 mat-dialog-title>Modifier mon profil</h2>
  <mat-dialog-content>
    <form [formGroup]="updateForm" class="update-form">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Nouvel e-mail</mat-label>
        <input matInput formControlName="email" placeholder="mon@mail.com">
        <mat-error *ngIf="email.invalid && email.touched">
          Un e-mail valide est requis
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Nouveau mot de passe</mat-label>
        <input matInput type="password" formControlName="password" placeholder="••••••••">
        <mat-error *ngIf="password.invalid && password.touched">
          Au moins 6 caractères
        </mat-error>
      </mat-form-field>
    </form>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Annuler</button>
    <button mat-raised-button color="primary" (click)="onUpdate()" [disabled]="updateForm.invalid">
      Enregistrer
    </button>
  </mat-dialog-actions>
</ng-template>
