<app-header></app-header>

<div class="profile-wrapper">
  <!-- Affichage du profil -->
  <mat-card *ngIf="profile" class="profile-card">
    <mat-card-header>
      <mat-card-title>Mon profil</mat-card-title>
      <mat-card-subtitle>
        {{ profile.firstname }} {{ profile.lastname }}
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <div class="profile-info">
<!--        <p><strong>ID :</strong> {{ profile.id }}</p>-->
        <p><strong>Email :</strong> {{ profile.email }}</p>
        <p><strong>Sujets créés :</strong> {{ profile.topicsCreatedCount }}</p>
        <p><strong>Abonnements :</strong> {{ profile.subscriptionsCount }}</p>
<!--        <p><strong>Sujets abonnés :</strong> {{ profile.subscribedSubjectsCount }}</p>-->
      </div>

      <mat-divider></mat-divider>

      <h3>Liste d’abonnements</h3>
      <mat-list>
        <mat-list-item *ngFor="let s of profile.subscriptions">
          <mat-icon matListIcon>bookmark</mat-icon>
          <div matLine>
            Sujet #{{ s.name }} abonné le {{ s.subscribedAt | date:'dd/MM/yyyy' }}
          </div>
          <div matLine *ngIf="s.unsubscribedAt" class="unsub">
            – désabonné le {{ s.unsubscribedAt | date:'dd/MM/yyyy' }}
          </div>
        </mat-list-item>
      </mat-list>
    </mat-card-content>

    <!-- Expansion panel pour mise à jour -->
    <mat-expansion-panel #panel class="update-panel">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>edit</mat-icon> Modifier mon profil
        </mat-panel-title>
      </mat-expansion-panel-header>

      <form [formGroup]="updateForm" (ngSubmit)="onUpdate()" class="update-form">
        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Nouvel e-mail</mat-label>
          <input matInput formControlName="email" placeholder="mon@mail.com" />
          <mat-error *ngIf="email.invalid && email.touched">
            Un e-mail valide est requis
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Nouveau mot de passe</mat-label>
          <input matInput type="password" formControlName="password" placeholder="••••••••" />
          <mat-error *ngIf="password.invalid && password.touched">
            Au moins 6 caractères
          </mat-error>
        </mat-form-field>

        <div class="buttons">
          <button mat-button type="button" (click)="panel.close()">Annuler</button>
          <button mat-raised-button color="primary" type="submit" [disabled]="updateForm.invalid">
            Enregistrer
          </button>
        </div>
      </form>
    </mat-expansion-panel>
  </mat-card>

  <!-- Spinner + message d'erreur -->
  <ng-template #loadingOrError>
    <div class="status-container">
      <mat-progress-spinner *ngIf="loading" mode="indeterminate"></mat-progress-spinner>
      <div *ngIf="errorMsg" class="error">{{ errorMsg }}</div>
    </div>
  </ng-template>
</div>
